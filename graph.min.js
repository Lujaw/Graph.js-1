function Graph(b,c,a){this.canvas=null;this.context=null;this.lines=[];this.width=0;this.height=0;this.drawn=false;this.options={minValue:"auto",maxValue:"auto",padding:20,spacing:20,border:0,borderColor:"#fff",background:["#4E87B5","#86A6C1"],grid:true,gridSize:1,gridColor:"rgba(255, 255, 255, 0.6 )",gridShadow:true,gridDotted:true,axisSize:"auto",axisColor:"auto",axisShadow:"auto",bullets:true,bulletSize:6,bulletColor:"#000",bulletFill:false,bulletShadow:true,shadowColor:"rgba(0, 0, 0, 0.6)",fill:true,fillColor:"rgba(255,255,255,0.3)",lineSize:3,lineCurve:true,lineColor:"#eee",useOffset:true,valueKey:"value"};
if(!this.init(b)){alert("[graph] invalid canvas element, aborting.");return false;}if(c){this.addLine(c,"default");}if(a){this.draw();}}Graph.prototype.init=function(a){if(!a||!a.getContext){return false;}this.canvas=a||false;this.context=this.canvas.getContext("2d");this.width=Math.max(this.canvas.width,this.canvas.clientWidth);
this.height=Math.max(this.canvas.height,this.canvas.clientHeight);return true;};Graph.prototype.addLine=function(f,c){var e=[];var b=[];for(var a=0;a<f.length;a++){if(typeof(f[a])=="number"){e.push(f[a]);}else{var g={};for(var d in f[a]){if(f[a][d].hasOwnProperty()){continue;}g[d]=f[a][d];}if(typeof(f[a][this.options.valueKey])=="undefined"){alert("[Graph] invalid meta-data, no '"+this.options.valueKey+"' field found.");
return;}e.push(f[a][this.options.valueKey]);b.push(g);}}this.lines.push({data:e,color:c||"default",bullets:[],meta:b});if(this.drawn){this.redraw();}};Graph.prototype.getLines=function(){return this.lines;};Graph.prototype.clearLines=function(){this.lines=null;delete this.lines;this.lines=[];};Graph.prototype.draw=function(){if(this.options.background!==false){this.drawBackground();
}if(this.options.grid){this.drawGrid();}for(var b=0;b<this.lines.length;b++){this.lines[b]["bullets"]=this.calculateBulletPoints(this.lines[b]["data"]);var a=this.calculateControlPoint(this.lines[b]["bullets"]);this.lines[b]["start"]=a.start;this.lines[b]["end"]=a.end;if(this.options.fill){this.fillLineData(this.lines[b],this.lines[b]["color"]=="default"?this.options.fillColor:this.lines[b]["color"]);
}var c=(!this.options.fill?this.lines[b]["color"]:"default");this.drawLineData(this.lines[b],c);if(this.options.bullets){this.drawBulletPoints(this.lines[b],c);}}this.drawn=true;};Graph.prototype.drawBackground=function(){if(this.options.border>0){this.context.fillStyle=this.parseColor(this.options.borderColor);
this.context.fillRect(0,0,this.width,this.height);this.context.fillStyle=this.parseColor(this.options.background);this.context.fillRect(this.options.border,this.options.border,this.width-(this.options.border*2),this.height-(this.options.border*2));}else{this.context.fillStyle=this.parseColor(this.options.background);
this.context.fillRect(0,0,this.width,this.height);}};Graph.prototype.drawGrid=function(){var o=this.options.padding+(this.options.border>0?this.options.border:0);var l=o;var j=this.height-o;var p=this.height-(o*2);var c=this.width-(o*2);var d=this.lines[0]["data"].length;var b=c;if(this.lines.length>1){for(var h=0;
h<this.lines.length;h++){if(this.lines[h]["data"].length>d){d=this.lines[h]["data"].length;}}}b=b/(d-1);this.context.strokeStyle=this.options.gridColor;this.context.lineWidth=this.options.gridSize;if(this.options.gridShadow){this.context.shadowOffsetX=0;this.context.shadowOffsetY=0;this.context.shadowBlur=2;
this.context.shadowColor=this.options.shadowColor;}else{this.context.shadowBlur=0;}var a=2;var e=(j-o);var f=e/a;for(var g=0;g<d;g++){var k=l+(g*b);if(this.options.gridDotted&&g>0){var n=o;this.context.strokeStyle=this.options.gridColor;this.context.lineWidth=this.options.gridSize;if(this.options.gridShadow){this.context.shadowOffsetX=0;
this.context.shadowOffsetY=0;this.context.shadowBlur=2;this.context.shadowColor=this.options.shadowColor;}else{this.context.shadowBlur=0;}while(n+a<=e+o){this.context.beginPath();this.context.moveTo(k,n);this.context.lineTo(k,n+a);this.context.stroke();n+=(a*2);}}else{this.context.strokeStyle=g>0||this.options.axisColor=="auto"?this.options.gridColor:this.options.axisColor;
this.context.lineWidth=g>0||this.options.axisSize=="auto"?this.options.gridSize:this.options.axisSize;var m=g>0||this.options.axisShadow=="auto"?this.options.gridShadow:this.options.axisShadow;if(m){this.context.shadowOffsetX=0;this.context.shadowOffsetY=0;this.context.shadowBlur=2;this.context.shadowColor=this.options.shadowColor;
}else{this.context.shadowBlur=0;}this.context.beginPath();this.context.moveTo(k,o);this.context.lineTo(k,j);this.context.stroke();}}var m=this.options.axisShadow=="auto"?this.options.gridShadow:this.options.axisShadow;if(m){this.context.shadowOffsetX=0;this.context.shadowOffsetY=0;this.context.shadowBlur=2;
this.context.shadowColor=this.options.shadowColor;}else{this.context.shadowBlur=0;}this.context.strokeStyle=this.options.axisColor=="auto"?this.options.gridColor:this.options.axisColor;this.context.lineWidth=this.options.axisSize=="auto"?this.options.gridSize:this.options.axisSize;this.context.beginPath();
this.context.moveTo(l,j);this.context.lineTo((this.width-l),j);this.context.stroke();};Graph.prototype.drawBulletPoints=function(g,f){var d=g.bullets;var j=this.options.padding+(this.options.border>0?this.options.border:0);var i=j;var h=this.height-j;var k=this.height-(j*2);var b=this.width-(j*2);var c=d.length;
var f=f||"default";this.context.lineWidth=this.options.bulletSize/3;this.context.lineWidth=this.context.lineWidth<1?1:this.context.lineWidth;this.context.strokeStyle=this.parseColor(f=="default"?this.options.lineColor:f);this.context.fillStyle=this.options.bulletFill?this.parseColor(this.options.bulletColor):this.context.strokeStyle;
if(this.options.bulletShadow){this.context.shadowOffsetX=0;this.context.shadowOffsetY=0;this.context.shadowBlur=this.options.lineSize-1;this.context.shadowColor=this.options.shadowColor;}else{this.context.shadowBlur=0;}for(var e=0;e<d.length;e++){var a=d[e];this.context.beginPath();this.context.arc(a.x,a.y,this.options.bulletSize,0,Math.PI*2,false);
this.context.closePath();this.context.fill();if(this.options.bulletFill){this.context.stroke();}}};Graph.prototype.drawLineData=function(h,f){var d=h.bullets;var l=this.options.padding+(this.options.border>0?this.options.border:0);var j=l;var i=this.height-l;var m=this.height-(l*2);var b=this.width-(l*2);
var c=d.length;var f=f||"default";this.context.beginPath();this.context.moveTo(d[0].x,d[0].y);if(this.options.gridShadow){this.context.shadowOffsetX=0;this.context.shadowOffsetY=0;this.context.shadowBlur=this.options.lineSize-1;this.context.shadowColor=this.options.shadowColor;}else{this.context.shadowBlur=0;
}this.context.strokeStyle=this.parseColor(f=="default"?this.options.lineColor:f);this.context.lineWidth=this.options.lineSize;this.context.lineCap="round";this.context.lineJoin="bevel";for(var e=0;e<d.length;e++){var a=d[e];var g=typeof(d[e-1])!="undefined"?d[e-1]:a;var k=typeof(d[e+1])!="undefined"?d[e+1]:a;
if(!this.options.lineCurve){this.context.lineTo(a.x,a.y);}else{if(c<3){alert("[graph] cannot curve lines with less than 3 bullets points.");return false;}else{if(e==(d.length-1)){break;}}if(e==0){this.context.moveTo(a.x,a.y);}this.context.bezierCurveTo(h.start[e].x,h.start[e].y,h.end[e].x,h.end[e].y,k.x,k.y);
}}this.context.stroke();};Graph.prototype.fillLineData=function(h,f){var d=h.bullets;var l=this.options.padding+(this.options.border>0?this.options.border:0);var j=l;var i=this.height-l;var m=this.height-(l*2);var b=this.width-(l*2);var c=d.length;this.context.beginPath();this.context.moveTo(j,i);this.context.shadowBlur=0;
for(var e=0;e<d.length;e++){var a=d[e];var g=typeof(d[e-1])!="undefined"?d[e-1]:a;var k=typeof(d[e+1])!="undefined"?d[e+1]:a;if(!this.options.lineCurve){this.context.lineTo(a.x,a.y);}else{if(c<3){alert("[graph] cannot curve lines with less than 3 bullets points.");return false;}else{if(e==(d.length-1)){break;
}}if(e==0){this.context.moveTo(a.x,a.y);}this.context.bezierCurveTo(h.start[e].x,h.start[e].y,h.end[e].x,h.end[e].y,k.x,k.y);}}this.context.lineTo(j+b,i);this.context.lineTo(j,i);this.context.fillStyle=f;this.context.fill();};Graph.prototype.getMinimum=function(c){var b=[];var c=c===true?this.options.spacing:0;
for(var a=0;a<this.lines.length;a++){b.push(Math.min.apply(Math,this.lines[a]["data"]));}return Math.min.apply(Math,b)-c;};Graph.prototype.getMaximum=function(c){var b=[];var c=c===true?this.options.spacing:0;for(var a=0;a<this.lines.length;a++){b.push(Math.max.apply(Math,this.lines[a]["data"]));}return Math.max.apply(Math,b)+c;
};Graph.prototype.calculateBulletPoints=function(r){var h=this.options.padding+(this.options.border>0?this.options.border:0);var o=h;var n=this.height-h;var k=this.height-(h*2);var l=this.width-(h*2);var b=r.length;var j=this.options.minValue=="auto"?this.getMinimum(true):this.options.minValue;var p=this.options.maxValue=="auto"?this.getMaximum(true):this.options.maxValue;
var a=[];var c=l/(b-1);var d=o;var q=Math.abs(p-j);var f=k/100;for(var e=0;e<b;e++){var m=r[e]-j;var g=Math.round((m/q)*100);var i=n-(f*g);a.push({x:d,y:i,value:r[e],number:e});d+=c;}return a;};Graph.prototype.calculateControlPoint=function(f){var c=f.length-1;var e=[];var b=[];var d=[];var g=[];for(var a=1;
a<(c-1);a++){e[a]=4*f[a].x+2*f[a+1].x;b[a]=4*f[a].y+2*f[a+1].y;}e[0]=f[0].x+2*f[1].x;b[0]=f[0].y+2*f[1].y;e[c-1]=(8*f[c-1].x+f[c].x)/2;b[c-1]=(8*f[c-1].y+f[c].y)/2;var e=this.processControlPoint(e);var b=this.processControlPoint(b);for(var a=0;a<c;a++){d[a]={x:e[a],y:b[a]};}for(var a=0;a<c;a++){if(a<(c-1)){g[a]={x:2*f[a+1].x-d[a+1].x,y:2*f[a+1].y-d[a+1].y};
}else{g[a]={x:(f[c].x+d[a].x)/2,y:(f[c].y+d[a].y)/2};}}return{start:d,end:g};};Graph.prototype.processControlPoint=function(e){var d=e.length;var c=[];var f=[];f[0]=2;for(var b=1;b<d;b++){var a=1/f[b-1];f[b]=(b<(d-1)?4:3.5)-a;e[b]-=a*e[b-1];}c[d-1]=e[d-1]/f[d-1];for(var b=(d-2);b>=0;b--){c[b]=(e[b]-c[b+1])/f[b];
}return c;};Graph.prototype.clear=function(){this.context.clearRect(0,0,this.width,this.height);this.canvas.width=this.width;};Graph.prototype.redraw=function(){this.clear();this.draw();};Graph.prototype.getGridAxes=function(){var k=this.options.padding+(this.options.border>0?this.options.border:0);var j=k;
var g=this.height-k;var l=this.height-(k*2);var b=this.width-(k*2);var c=this.lines[0]["data"].length;var a=b;var d={x:[],y:"not yet supported"};if(this.lines.length>1){for(var f=0;f<this.lines.length;f++){if(this.lines[f]["data"].length>c){c=this.lines[f]["data"].length;}}}a=a/(c-1);for(var e=0;e<c;
e++){var h=j+(e*a);d.x.push({y:g,x:h});}return d;};Graph.prototype.getClosestBullet=function(j,g){var h=[];var g=g===false?false:true;if(this.options.useOffset){var j=j-this.getOffset().x;}if(g){this.redraw();}for(var l=0;l<this.lines.length;l++){var e=this.lines[l]["bullets"];var m=this.lines[l]["meta"];
var d=e.length;var c=false;var b=this.width/(d-1);for(var f=0;f<d;f++){var a=e[f];var i=f==0?0:a.x-b;var k=Math.floor((a.x-i)/2)-(this.options.padding/2);if(j<i||j>a.x){continue;}if(j<=(i+k)){c=f==0?a:e[f-1];c.meta=f==0?m[f]:m[f-1];break;}else{c=a;c.meta=m[f];break;}}h.push(c);this.context.strokeStyle=this.parseColor(this.lines[l]["color"]=="default"?this.options.lineColor:this.lines[l]["color"]);
this.context.fillStyle=this.options.bulletFill?this.parseColor(this.options.bulletColor):this.context.strokeStyle;if(g){this.context.beginPath();this.context.arc(c.x,c.y,(this.options.bulletSize*1.4),0,Math.PI*2,false);this.context.closePath();this.context.fill();if(this.options.bulletFill){this.context.stroke();
}}}if(h.length==0){return[];}else{if(h.length==1){return h[0];}}return h;};Graph.prototype.getOffset=function(){var a=this.canvas;var b=this.options.padding+(this.options.border>0?this.options.border:0);var c={x:b,y:b};while(a&&a.offsetParent){c.x+=a.offsetLeft;c.y+=a.offsetTop;a=a.offsetParent;}return c;
};Graph.prototype.parseColor=function(a){if(typeof(a)=="object"||typeof(a)=="array"){var e=this.context.createLinearGradient(0,0,0,this.height);var d=1/(a.length-1);for(var c=0;c<a.length;c++){var b=c*d;if(b>1){b=1;}e.addColorStop(b,a[c]);}return e;}return a;};Graph.prototype.toString=function(){return"[object Graph.js]";
};